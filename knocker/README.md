Инструкция по эксплуатации
==

Приложение предназначено для запуска docker-контейнеров с экземпляром проекта
"близко" (далее "проект") внутри.

Для запуска контейнера необходимо:
  1. Собрать базовый образ проекта, если он отсутствует.
  2. Собрать рабочий образ проекта на основе базового, указав в качестве
     параметра сборки ветку кода проекта.
  3. Запустить контейнер из собранного рабочего образа.

Сборка базового образа
---

Базовый образ представляет собой эталонное окружение проекта, включающее:
  - OS
  - сервисы
  - пакеты
  - код blizko (develop)
  - раскатанный эталонный дамп

При этом:
  - базовый образ содержит неактуальный код проекта;
  - эталонное окружение является неполным.

И потому:
  - **запуск контейнеров непосредственно из базового образа осуществляться не
    должен**!
  - базовый образ не требует постоянной пересборки (например, для поддержания
    актуальности кода).

Сборка базового образа требует особого внимания со стороны администратора
docker-хоста, поэтому базовый образ должен быть собран на момент начала
эксплуатации приложения.

Инструкция по сборке базового образа: knife/blizko_base/README

Имя базового образа: "blizko_base_develop"
  * **blizko**:  имя проекта
  * **base**:    имя окружения
  * **develop**: имя ветки внутри

Сборка рабочего образа
---

Рабочий образ предсталвляет собой полноценное окружение с актуальной версией
кода выбранной ветки проекта:

[**код проекта**]
  - актуальное состояние ветки (git pull)

[**окружение**]
  - актуальное состояние базы  (db:migrate)
  - проиндексированный sphinx  (sphinx:rebuild)
  - прекомпилированные ассеты  (assets:precompile)
  - импорт и другое            (knife:prepare)
  - пользовательские файлы     (статика).

Чтобы собрать рабочий образ необходимо указать:
  1. **Имя образа** (**окружения**), на основе которого будет строиться требуемый образ.
     В качестве такого окружения может выступать как базовый образ, так и
     пользовательские образы (см. раздел 'пользовательские образы').
  2. **Ветку** кода проекта.

Приложение подтягивает актуальную версию ветки и обновляет окружение
(мигрирует БД, индексирует sphinx и т.д.).

Если образ с выбранным окружением и актуальной версией ветки уже существует,
то приложение его по-новой **не создает**.

Приложение собирает образ и по окончанию выводит его имя, получаемое по
следующему правилу:

<sub><**имя** **проекта**>\_<**имя выбранного окружения**>\_<**имя выбранной ветки**>:<**hash  коммита**></sub>

Ex:

  1) Собирает образ с веткой '**master**' на основе базового образа/окружения
     '**blizko_base_develop**':

      >  ./bin/knocker build -i blizko_base_develop -b master

      # => blizko_base_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68

  2) Собирает образ с веткой '**feature1**' на основе пользовательского
     образа/окружения  '**blizko_my-env_develop:3df90fb79cb19079f4c2d7398d08a393aa69a65e**':

      >  ./bin/knocker build -i blizko_my-env_develop:3df90fb79cb19079f4c2d7398d08a393aa69a65e -b feature1

      # => blizko_my-env_feature1:8d08a393aa69a65e3df90fb79cb19079f4c2d739

Получить список доступных образов и веток кода проекта:
  > ./bin/knocker build -l

Запуск рабочего образа
---

Из отдельно взятого образа может быть запущено несколько независимых
контейнеров, каждый из которых получает собственное доменное имя (генерируемое
случайным образом), по которому можно обратиться к веб-интерфейсу запущенного
внутри него проекта.

Приложение запускает контейнер и выводит корневой url проекта.

При этом проект внутри контейнера становится доступным **не сразу**, а лишь спустя
некоторое время, требуемое для запуска всего необходимого для его работы.

Ex:

   Запускает контейнер из образа '**blizko_base_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68**':

      > ./bin/knocker run -i blizko_base_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68

      # => http://www.random-name.master.base.blizko.knf.railsc.ru

Получить список доступных образов:
  > ./bin/knocker run -l

Построение образа и запуск контейнера из него можно объединить, запустив
команду build с ключом '**-r**'

Ex:

  Собирает образ с веткой '**master**' на основе базового образа/окружения
  '**blizko_base_develop**' и запускает полученный образ:

    > ./bin/knocker build -i blizko_base_develop -b master -r

    # => blizko_base_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68
    # => http://www.random-name.master.base.blizko.knf.railsc.ru

Пользовательские образы
---

Работая с проектом внутри контейнера, пользователь тем самым изменяет окружение
внутри него: создает/удаляет/изменяет контент проекта, изменяет настройки
проекта, пакетов и т.д. Такое окружение (контейнер) можно сохранить
в отдельный образ (пользовательский образ), задав ему имя, а затем использовать
для построения образов с обновленным кодом ветки или с кодом другой ветки.

Пример сценария:

На основе базового образа и ветки master создали рабочий образ и запустили из
него контейнер:

    > ./bin/knocker build -i blizko_base_develop -b master -r

    # => blizko_base_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68
    # => http://www.random-name.master.base.blizko.knf.railsc.ru

  Поработали с проектом, обнаружили багу, создали задачу в jira 'BPC-4242'.

  Сохраняем полученное окружение (выступающее в данном случае как контекст
  баги), задавая ему имя:

    > ./bin/knocker commit -c blizko_base_master_random-name -e BPC-4242

    # => blizko_BPC-4242_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68

  Впоследствии разработчики пофиксят баг и обновят код ветки master. Воссоздаем
  контекст баги с обновленным кодом, строя и запуская новый образ на основе
  окружения '**BPC-4242**' и ветки '**master**'.

    > ./bin/knocker build -i blizko_BPC-4242_master:fe9748f624bf22d1a3a0c59e11af91eea4896c68 -b master -r

    # => blizko_BPC-4242_master:a3a0c59e11af91eea4896c68fe9748f624bf22d1
    # => http://www.random-name.master.BPC-4242.blizko.knf.railsc.ru


Для получения списка конейнеров:
  > ./bin/knocker commit -l
